# puppet lesson

## problem without configuration management  
- Manual management of infra \
- No version control, rollback is difficult and time consuming \
- Might lead to down time of infra \
- Conflict between different platform, compatibility issue \

## What is configuration management?
- Infrastructure as Code \
  - Track (version controlled), get git history, commit changes \
  - Test \
  - Deploy \
  - Reproduce \
  - Scale up quickly(within min) \
- version controlled \
- centralized location \
- rollback is quick \
- No conflict with different environments(Aligned environments and coherent and consistent server setup) \

## What is puppet?
- is configuration management tool that is used for \
  - deploying \
  - configuring and \
  - managing servers \
- it uses master(puppet-master)-salve(puppet-agent) architecture \
- Used is ruby language \
- Has UI called puppet console \
- puppet is collection of tools \
- puppet is used  either local command line tool or client master relationship \
##Features:
- It controls all the steps, right from bootstrapping to the end of server life \
- Can define configuration at the node level \
- Can group them according to roles \
  - Example: Webservers and DB servers \
- Maintains consistency across nodes \
  - example, if a change is done locally on the node, it is rolled back to original configuration \

# Software related to puppet:
1. Facter - is a puppet's cross-platform system profiling library. It finds and reports per-node facts, which are available in Puppet manifest as variables.
2. MCollective - Infrastructure orchestration framework(command line tool)
3. Hiera - Puppet data can be placed using this key-value lookup tool
4. PuppetDB - Data generated by puppet is stored here
5. Puppet Dashboard - A Puppet web frontend and External Node Classifier (ENC)
6. The Foreman - A well-known third party provisioning tool and Puppet ENC
7. Geppetto - A Puppet IDE bases on Eclipse

# puppet Architecture
-

# How puppet works
- Puppet works on the master Server model
  1. Puppet master : This machine all the configuration for different hosts. Puppet master will run as daemon on this master server.
  2. Puppet agent: This is daemon runs on each node and talks to the master
  3. The connection between these two machines is made in a secure encrypted channel wit the help of SSL

# puppet configuration
1. Clients connect to the master and master identifies the configuration according to the client
2. master builds the configuration that needs to be applied to the host, compiles it and makes it ready
3. Clients pull the configuration and apply them on the respective nodes

# puppet terminology
1. Resources
  - Puppet code is primarily composed of resource declarations \
  - A resource describes about the state of the system \
  - Resource declarations can be formatted as below \
    ```
    resource_type
      {'resource_name'
      attribute => value
      ...  
      }
      ```
    ```
    user
    {'mitchell':
      ensure => present
      uid => '1000',
      gid => '1000',
      shell => "/bin/bash",
      home => '/home/mitchell'
    }
    ```
  - to list all the default resource types that are available to Puppet, enter the following command:\
  `puppet resource-types`

2. Manifests
- Puppet programs are called manifests \
- Manifests are composed of Puppet code and their filenames uses the .pp extension \
- The default main manifest in Puppet installed via apt is:\
  `/etc/puppet/manifests/site.pp`

3. Class
- In puppet, Classes are code blocks that can be called in a code elsewhere. Using classes allows to reuse Puppet code, and can make reading manifest easier \
- Class defination \
  ```
  class example_class {
    code
    ...
    ...
  }
  ```
- Class Declaration # Execute the code \
  1. Normal Class
  ```
  include example_class
  ```
  2. resource-like class
  ```
  class {'example_class':}
```
4. Modules
  - A module is a collection of manifests and data(such as facts, files, and templates), and they have specific directory structure\
  - useful for organizing the puppet code
  - Best practice to use modules
  - To add modules to the puppet, place it in the `/etc/puppet/modules` directory

# LAB
## Puppet Master
1. Launch EC2 redhat in AWS console , make sure port 8140 (puppetserver port) is open in SG
2. SSH to EC2 instance
3. `sudo su`
4. `yum update`
5. Follow this step for Puppet master setup: \
https://linuxconfig.org/how-to-install-puppet-on-redhat-8
```
  dnf install https://yum.puppetlabs.com/puppet-release-el-8.noarch.rpm
  dnf install puppetserver

  #Puppet is install under the folder /opt/ and need to setup .bashrc to execute the command
  # vi .bashrc and add this line PATH=/opt/puppetlabs/bin:$PATH and source .bashrc

  # configure the /etc/hosts, add below line to hosts file
    <puppet-master-ip> puppet

  # get the latest puppet version
  puppet resource package puppetserver ensure=latest

  #start puppet
  systemctl start puppetserver  #this did not work
  OR
  puppet resource service puppetserver ensure=running # this worked

    #it failed with below error

    Job for puppetserver.service failed because the control process exited with error code.
    See "systemctl status puppetserver.service" and "journalctl -xe" for details.
  #Fix https://stackoverflow.com/questions/48436409/job-for-puppetserver-service-failed-because-the-control-process-exited-with-erro
    vi /etc/sysconfig/puppetserver
    #update the memory allocation from -Xms2g -Xmx2g to -Xms200m -Xmx200m
    # Puppet needs atleast 4 G of RAM to work. For learning purpose I am going to use 200M

 # You can always enable it at start too.

 systemctl enable puppetserver #this did not work
 OR
 puppet resource service puppetserver enable=true #this worked

  ```
## Puppet Client
1. dnf install https://yum.puppetlabs.com/puppet-release-el-8.noarch.rpm
2. set the path vi .bashrc and add this line PATH=/opt/puppetlabs/bin:$PATH and source .bashrc
3. `puppet resource package puppet ensure=latest`
4. `puppet resource service puppet ensure=running`
5. `puppet resource service puppet enable=true`
6. Add below line to the file
```
[agent]
server=ip-172-31-5-189.us-west-2.compute.internal
```
7. run this command to generate the SSL certificate and to share with master node
`puppet agent -t`
8. Go to master puppet and trust the certiticate
`puppetserver ca list --all` get the pending certificate name
` puppetserver ca sign --certname ip-172-31-1-134.us-west-2.compute.internal` #signed the certificate

- server ip address is master puppet IP address got by running `puppetserver ca list --all` on puppet master node


## Deploy Apache tomcat
1. Install java and tomcat modules on master node
`puppet module install puppetlabs-java`
`puppet module install puppetlabs-tomcat`
2. Create site.pp manifest file and add below content
path: vi /etc/puppetlabs/code/environments/production/manifests/site.pp

```
class {'java' :
  package => 'java-1.8.0-openjdk-devel',  
}

tomcat::install {'/opt/tomcat/':
  source_url => 'https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.0.M1/bin/apache-tomcat-9.0.0.M1.tar.gz',
}
tomcat::instance {'default':
  catalina_home => '/opt/tomcat',
}
```
# Commands
`puppetserver ca list --all`
`puppet resource service puppetserver ensure=stopped`
`puppetserver ca setup` #regenerate the master CA certificate

agent
`puppet agent -t` # this will generate client cert and also pull changes from master
